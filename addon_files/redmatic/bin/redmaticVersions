#!/bin/sh

ADDON_DIR=/usr/local/addons/redmatic
GLOBAL_MODULES=$ADDON_DIR/lib/node_modules
LOCAL_MODULES=$ADDON_DIR/var/node_modules

NODE=$ADDON_DIR/bin/node

export PATH=$ADDON_DIR/bin:$PATH
export LD_LIBRARY_PATH=$ADDON_DIR/lib:$LD_LIBRARY_PATH
export NO_UPDATE_NOTIFIER=true

source $ADDON_DIR/versions

JO_ARGS=""

# TODO handle scoped packages
for dir in $GLOBAL_MODULES/*
do
    dir=${dir%*/}
    PKG=${dir##*/}
    PKGJSON=$GLOBAL_MODULES/$PKG/package.json
    if [[ -f $PKGJSON ]]; then
        JO_ARGS="$JO_ARGS $PKG=`jq -r '.version' $GLOBAL_MODULES/$PKG/package.json`"
    fi
done

for dir in $LOCAL_MODULES/*
do
    dir=${dir%*/}
    PKG=${dir##*/}
    PKGJSON=$LOCAL_MODULES/$PKG/package.json
    if [[ -f $PKGJSON ]]; then
        JO_ARGS="$JO_ARGS $PKG=`jq -r '.version' $LOCAL_MODULES/$PKG/package.json`"
    fi
done

jo -p ccu=`(cat /VERSION && echo -n "deviceTypes=" && $ADDON_DIR/bin/deviceTypes) | jo` \
    redmatic=$VERSION_ADDON \
    nodejs=`node --version | cut -c 2-` \
    $JO_ARGS

